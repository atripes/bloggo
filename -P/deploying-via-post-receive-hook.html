<!DOCTYPE html>
<html>

<head>
	<title>devblog</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
	<link rel="stylesheet" href="/assets/css/main.css" />
	<!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
	<!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
</head>


<body>

    <!-- Wrapper -->
<div id="wrapper">

<!-- Header -->
<header id="header">
	<a href="http://localhost:4000/" class="logo"><strong>devblog</strong> <span>by atripes</span></a>
	<nav>
		<a href="#menu">Menu</a>
	</nav>
</header>

<!-- Menu -->
<nav id="menu">
	<ul class="links">
        
		    
		        <li><a href="http://localhost:4000//"></a></li>
	    	
		
		    
		
		    
		
		    
		
		    
		        <li><a href="http://localhost:4000//">Home</a></li>
	    	
		
		    
		
		    
		
		
		    
		
		    
		        <li><a href="http://localhost:4000/about">About</a></li>
		    
		
		    
		
		    
		
		    
		
		    
		
		    
		
	</ul>
	<!--ul class="actions vertical">
		<li><a href="#" class="button special fit">Get Started</a></li>
		<li><a href="#" class="button fit">Log In</a></li>
	</ul-->
</nav>
 
    
    
<!-- Main -->
<div id="main" class="alt">

<!-- One -->
<section id="one">
	<div class="inner">
		<header class="major">
			<h1>Deploying via post-receive hook</h1>
		</header>
		
		<p><p>Itâ€™s amlost as flexible and verbose as gitlabs CI feature. But without all the overhead.
For me, the key was setting up the bare git repo on the production server:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~/project_name
git init --bare
</code></pre></div></div>
<p>To this repo we will push later on. This repo also needs the post-receive hook:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch ./hooks/post-receive
chmod a+x ./hooks/post-receive
</code></pre></div></div>
<p>It needs to be executable. Put this code into the hook file:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">cd</span> /var/www/project_name

<span class="k">while </span><span class="nb">read </span>oldrev newrev ref
<span class="k">do
	</span><span class="nb">echo</span> <span class="s2">"Ref </span><span class="nv">$ref</span><span class="s2"> successfully received. Deploying the server..."</span>
	git <span class="nt">--work-tree</span><span class="o">=</span>/var/www/project_name <span class="nt">--git-dir</span><span class="o">=</span>/home/user/project_name checkout develop <span class="nt">-f</span>
<span class="k">done</span>
</code></pre></div></div>
<p>Since this script gets its params from stdin instead of cli parameters you need to fetch them with <code class="highlighter-rouge">read</code>. because there could be more than one branch pushed, you need to do this for each one seperate, hence the <code class="highlighter-rouge">while</code> loop. in fact, this never comes into play at my deployments, because when i push to production, i always ever push master.</p>

<p>What this does is, it checks out the project into <code class="highlighter-rouge">/var/www/project_name</code> which in this case is the location that I serve my site from. In the case of my jekyll application there are still things to do for it to run (protip at the bottom of this doc how to solve it).</p>

<p>Ah, btw. How to push.
You are on your dev machine, working on the project, pushing happily into whatever repository holds your code. For this deployment routine to work you need to add an additional remote:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git remote add production ssh://user@prodserver.com:~/project_name
</code></pre></div></div>
<p>And you push your current master with:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git push production master
</code></pre></div></div>
<p>The push will return whatever stdout it received, so you will know wether it worked or not.
Thanks to <code class="highlighter-rouge">http://www.janosgyerik.com/deploying-new-releases-using-git-and-the-post-receive-hook/</code> to get me started on this topic.</p>

<p>Protip:
You can add whatever deployment routine you want after that checkout. In my case I am building and restarting a jekyll app, and the command looks like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git --work-tree=/var/www/project_name --git-dir=/home/user/project_name checkout master -f &amp;&amp; jekyll build &amp;&amp; jekyll serve --detach
</code></pre></div></div>
</p>
	</div>
</section>

</div>

    <!-- Footer -->
	<footer id="footer">
		<div class="inner">
			<ul class="icons">
				
				
				
				
				
				
				
				
				
				
			</ul>
			<ul class="copyright">
				<li>&copy; devblog by atripes</li>
				<li>Design: <a href="https://html5up.net" target="_blank">HTML5 UP</a></li>
				<li>Jekyll integration: <a href="http://andrewbanchi.ch" target="_blank">Andrew Banchich</a></li>

			</ul>
		</div>
	</footer>

</div>

<!-- Scripts -->
	<script src="http://localhost:4000/assets/js/jquery.min.js"></script>
	<script src="http://localhost:4000/assets/js/jquery.scrolly.min.js"></script>
	<script src="http://localhost:4000/assets/js/jquery.scrollex.min.js"></script>
	<script src="http://localhost:4000/assets/js/skel.min.js"></script>
	<script src="http://localhost:4000/assets/js/util.js"></script>
	<!--[if lte IE 8]><script src="http://localhost:4000/assets/js/ie/respond.min.js"></script><![endif]-->
	<script src="http://localhost:4000/assets/js/main.js"></script>


</body>

</html>
